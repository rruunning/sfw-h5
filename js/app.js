const DATA = {
  "guides": [
    {
      "title": "银河奖征文（核心征稿）",
      "content": [
        "征稿类别：原创短篇 / 中篇科幻小说。",
        "投稿邮箱：tougao@sfw.com.cn。",
        "作品需为作者原创、未发表稿件，科幻点鲜明，兼具文学性与思想性。",
        "可在邮件标题中注明“银河奖征文 - 作品名”。"
      ]
    },
    {
      "title": "正刊长篇 / 图书稿件",
      "content": [
        "长篇科幻小说一般在 12 万字以上。",
        "投稿邮箱：tushu@sfw.com.cn。",
        "需为完整稿件，不接收未完稿和只有大纲的稿件。",
        "建议在邮件标题中注明“长篇科幻原创小说征稿 - 作品名”。"
      ]
    },
    {
      "title": "校园之星（学生专栏）",
      "content": [
        "征文对象：中小学、中专院校在校学生。",
        "字数：短篇 5000 字以内。",
        "投稿邮箱：xiaoyuan@sfw.com.cn。",
        "需在邮件中附上年级、真实姓名、联系方式与 200 字以内故事梗概，正文建议使用 Word 文档附件。"
      ]
    },
    {
      "title": "脑洞问答机 · 脑洞故事与点子",
      "content": [
        "栏目整合了短篇脑洞故事、一句话科幻、奇想设定等形式。",
        "短篇故事约 1000–3000 字；脑洞点子 20–200 字。",
        "投稿方式与具体邮箱以当期杂志公布信息为准，可参考校园之星邮箱 xiaoyuan@sfw.com.cn。"
      ]
    },
    {
      "title": "读者来信 / 有奖征集“我们的科幻世界”",
      "content": [
        "可以是读后感、阅读趣事，或对编辑部想说的话。",
        "投稿邮箱：echo@sfw.com.cn。",
        "编辑会选登部分内容，并不定期抽取读者赠送当期杂志等小礼物。"
      ]
    },
    {
      "title": "美术封面 / 插图征稿",
      "content": [
        "封面彩图：科幻幻想主题绘画，JPG 格式，建议尺寸约 26.6cm × 18.8cm，300dpi 以上。",
        "插图：多为按小说内容约稿，自由来稿可作为风格样稿。",
        "投稿邮箱：design@sfw.com.cn。",
        "邮寄地址：四川省成都市人民南路四段 11 号《科幻世界》美术投稿（610041），以当期杂志说明为准。"
      ]
    },
    {
      "title": "译文稿件征集与译者招募",
      "content": [
        "译文征稿：投稿邮箱 translation@sfw.com.cn，要求忠实原文、语言流畅，需确保版权合法。",
        "译者招募：可按官方要求附试译稿与个人简介，发送至相应编辑邮箱。",
        "译文栏目与《科幻世界·译文版》共同构成世界科幻引进平台。"
      ]
    }
  ],
  "works": [
    {
      "title": "穿越土星环",
      "author": "谢云宁",
      "origin": "中国原创长篇 · 科幻世界图书",
      "tags": [
        "硬科幻",
        "太空探索",
        "工程科学",
        "极限环境"
      ],
      "cover": "through-saturn-rings.jpg"
    },
    {
      "title": "三体",
      "author": "刘慈欣",
      "origin": "中国原创长篇 · 科幻世界连载起家",
      "tags": [
        "硬科幻",
        "外星文明",
        "文明演化",
        "思想实验"
      ],
      "cover": "three-body.jpg"
    },
    {
      "title": "名为帝国的回忆",
      "author": "Arkady Martine",
      "origin": "译文长篇 · 世界科幻大师丛书",
      "tags": [
        "太空歌剧",
        "文化接触",
        "语言系统",
        "政治结构"
      ],
      "cover": "memory-empire-en.jpg"
    },
    {
      "title": "城防十六计",
      "author": "K. J. Parker",
      "origin": "译文长篇 · 世界科幻大师丛书",
      "tags": [
        "架空历史科幻",
        "社会模拟",
        "战争结构",
        "政治制度"
      ],
      "cover": "walled-city.jpg"
    },
    {
      "title": "中局",
      "author": "Seanan McGuire",
      "origin": "译文长篇 · 科幻世界译文线",
      "tags": [
        "科技奇幻",
        "哲学科幻",
        "意识",
        "符号学"
      ],
      "cover": "middlegame.jpg"
    },
    {
      "title": "八头斯芬克斯与五十六个答案",
      "author": "K. J. Parker",
      "origin": "中篇 · 《科幻世界·译文版》",
      "tags": [
        "哲学科幻",
        "思想实验",
        "符号学",
        "解释权"
      ],
      "cover": "sphinx-cover.jpg"
    },
    {
      "title": "苦涩之种",
      "author": "Ian Tregillis",
      "origin": "译文长篇 · 神魔二战三部曲之一",
      "tags": [
        "架空历史科幻",
        "战争结构",
        "政治制度",
        "社会变迁"
      ],
      "cover": "bitter-seed.jpg"
    },
    {
      "title": "极冷之战",
      "author": "Ian Tregillis",
      "origin": "译文长篇 · 神魔二战三部曲之二",
      "tags": [
        "军事科幻",
        "架空历史科幻",
        "战争结构",
        "社会秩序"
      ],
      "cover": "coldest-war.jpg"
    },
    {
      "title": "米与盐的时代",
      "author": "Kim Stanley Robinson",
      "origin": "译文长篇",
      "tags": [
        "架空历史科幻",
        "历史分叉",
        "文明演化",
        "宗教系统"
      ],
      "cover": "years-rice-salt.jpg"
    },
    {
      "title": "神圣入侵",
      "author": "Philip K. Dick",
      "origin": "译文长篇",
      "tags": [
        "哲学科幻",
        "意识",
        "现实结构",
        "神学议题"
      ],
      "cover": "divine-invasion.jpg"
    },
    {
      "title": "太阳系大乐透",
      "author": "Philip K. Dick",
      "origin": "译文长篇",
      "tags": [
        "社会科幻",
        "社会模拟",
        "制度设计",
        "概率统治"
      ],
      "cover": "solar-lottery.jpg"
    },
    {
      "title": "炼金术战争三部曲",
      "author": "Ian Tregillis",
      "origin": "译文长篇系列",
      "tags": [
        "蒸汽朋克",
        "科技奇幻",
        "意识",
        "技术奇点"
      ],
      "cover": "alchemy-wars.jpg"
    },
    {
      "title": "去他的时间尽头",
      "author": "程婧波",
      "origin": "中国原创中篇 · 银河奖获奖作",
      "tags": [
        "都市科幻",
        "时间旅行",
        "意识",
        "身份问题"
      ],
      "cover": "f-time.jpg"
    }
  ],
  "quiz": [
    {
      "id": 1,
      "q": "你最希望科幻作品回答哪一类问题？",
      "options": [
        "文明如何在宇宙中生存与演化",
        "技术会把人类带向何处",
        "个人在宏大历史中的位置",
        "社会制度可以怎样被重新设计"
      ]
    },
    {
      "id": 2,
      "q": "你更偏好的科幻叙事尺度是？",
      "options": [
        "星际文明与银河级格局",
        "单一城市或国家的制度实验",
        "少数人物的命运与关系",
        "高度抽象的思想实验与结构游戏"
      ]
    },
    {
      "id": 3,
      "q": "以下哪一组关键词更吸引你？",
      "options": [
        "外星文明 / 黑暗森林 / 文明碰撞",
        "历史分叉 / 架空帝国 / 政治博弈",
        "意识 / 记忆 / 现实结构",
        "太空工程 / 航天器 / 极端环境"
      ]
    },
    {
      "id": 4,
      "q": "你对科学部分的期待是？",
      "options": [
        "尽量严谨，接近硬科幻",
        "适度合理，更重视社会与制度推演",
        "可以模糊，只要思想实验够锋利",
        "愿意接受魔幻与科技混合"
      ]
    },
    {
      "id": 5,
      "q": "你理想中的科幻阅读体验？",
      "options": [
        "史诗感，很长时间沉浸其中",
        "中篇长度，有完整世界和明确议题",
        "短篇与组诗式阅读，一次一个强点子",
        "混合型阅读，根据心情自由切换"
      ]
    }
  ]
};


/* Hero 向下滚动 */
function scrollToWorks(){
  const btn = document.getElementById("scroll-down-btn");
  const target = document.getElementById("works-section");
  if(btn && target){
    btn.addEventListener("click", ()=>{
      target.scrollIntoView({behavior:"smooth"});
    });
  }
}

/* 投稿指南渲染 */
function renderGuides(){
  const wrap = document.getElementById("guide-cards");
  if(!wrap) return;
  DATA.guides.forEach(g=>{
    const div = document.createElement("div");
    div.className = "card";
    const h3 = document.createElement("h3");
    h3.textContent = g.title;
    div.appendChild(h3);
    g.content.forEach(line=>{
      const p = document.createElement("p");
      p.textContent = line;
      div.appendChild(p);
    });
    wrap.appendChild(div);
  });
}

/* 书架渲染 */
function renderWorks(){
  const track = document.getElementById("works-track");
  if(!track) return;

  DATA.works.forEach(w=>{
    const card = document.createElement("div");
    card.className = "book-card";

    const img = document.createElement("img");
    img.className = "book-cover";
    img.src = "assets/covers/" + w.cover;
    img.alt = w.title;
    card.appendChild(img);

    const overlay = document.createElement("div");
    overlay.className = "book-overlay-info";

    const title = document.createElement("p");
    title.className = "book-title";
    title.textContent = w.title;
    overlay.appendChild(title);

    const tagsWrap = document.createElement("div");
    tagsWrap.className = "book-tags";
    w.tags.forEach(t=>{
      const span = document.createElement("span");
      span.className = "book-tag";
      span.textContent = t;
      tagsWrap.appendChild(span);
    });
    overlay.appendChild(tagsWrap);

    card.appendChild(overlay);
    track.appendChild(card);
  });

  setupDragScroll(track);
}

/* 书架拖动（无惯性，松手即停） */
function setupDragScroll(track){
  let isDown = false;
  let startX = 0;
  let scrollLeft = 0;

  track.addEventListener("mousedown", (e)=>{
    isDown = true;
    track.classList.add("dragging");
    const rect = track.getBoundingClientRect();
    startX = e.pageX - rect.left;
    scrollLeft = track.scrollLeft;
  });

  document.addEventListener("mouseup", ()=>{
    if(!isDown) return;
    isDown = false;
    track.classList.remove("dragging");
  });

  track.addEventListener("mouseleave", ()=>{
    if(!isDown) return;
    isDown = false;
    track.classList.remove("dragging");
  });

  track.addEventListener("mousemove", (e)=>{
    if(!isDown) return;
    e.preventDefault();
    const rect = track.getBoundingClientRect();
    const x = e.pageX - rect.left;
    const walk = x - startX;
    track.scrollLeft = scrollLeft - walk;
  });
}

/* 测试逻辑 */
let currentQIndex = 0;
let answers = {}; // {id: [indices]}

function renderQuiz(){
  const block = document.getElementById("quiz-question-block");
  const prevBtn = document.getElementById("quiz-prev");
  const nextBtn = document.getElementById("quiz-next");
  const resetBtn = document.getElementById("quiz-reset");
  const progress = document.getElementById("quiz-progress");

  if(!block || !prevBtn || !nextBtn || !resetBtn || !progress) return;

  function updateUI(){
    const q = DATA.quiz[currentQIndex];
    block.innerHTML = "";

    const qText = document.createElement("p");
    qText.className = "quiz-question-text";
    qText.textContent = "Q" + q.id + " " + q.q;
    block.appendChild(qText);

    const optsWrap = document.createElement("div");
    optsWrap.className = "quiz-options";
    const selected = new Set(answers[q.id] || []);
    q.options.forEach((opt, idx)=>{
      const optDiv = document.createElement("div");
      optDiv.className = "quiz-option";
      if(selected.has(idx)) optDiv.classList.add("selected");
      optDiv.textContent = opt;
      optDiv.addEventListener("click", ()=>{
        if(selected.has(idx)){
          selected.delete(idx);
        }else{
          selected.add(idx);
        }
        answers[q.id] = Array.from(selected);
        updateUI();
      });
      optsWrap.appendChild(optDiv);
    });
    block.appendChild(optsWrap);

    progress.textContent = "第 " + (currentQIndex+1) + " / " + DATA.quiz.length + " 题";
    prevBtn.disabled = currentQIndex === 0;
    nextBtn.textContent = (currentQIndex === DATA.quiz.length - 1) ? "查看结果" : "下一题";
  }

  prevBtn.addEventListener("click", ()=>{
    if(currentQIndex > 0){
      currentQIndex -= 1;
      updateUI();
    }
  });

  nextBtn.addEventListener("click", ()=>{
    if(currentQIndex < DATA.quiz.length - 1){
      currentQIndex += 1;
      updateUI();
    }else{
      showQuizResult();
    }
  });

  resetBtn.addEventListener("click", ()=>{
    answers = {};
    currentQIndex = 0;
    const resultDiv = document.getElementById("quiz-result");
    if(resultDiv) resultDiv.innerHTML = "";
    updateUI();
  });

  updateUI();
}

function showQuizResult(){
  const resultDiv = document.getElementById("quiz-result");
  if(!resultDiv) return;

  let hard = 0, alt = 0, philo = 0, space = 0;

  DATA.quiz.forEach(q=>{
    const sel = answers[q.id] || [];
    sel.forEach(idx=>{
      if(q.id === 1){
        if(idx === 0) space++;
        if(idx === 1) hard++;
        if(idx === 2) philo++;
        if(idx === 3) alt++;
      }
      if(q.id === 2){
        if(idx === 0) space++;
        if(idx === 1) alt++;
        if(idx === 2) philo++;
        if(idx === 3) hard++;
      }
      if(q.id === 3){
        if(idx === 0) space++;
        if(idx === 1) alt++;
        if(idx === 2) philo++;
        if(idx === 3) hard++;
      }
      if(q.id === 4){
        if(idx === 0) hard++;
        if(idx === 1) alt++;
        if(idx === 2) philo++;
        if(idx === 3) space++;
      }
      if(q.id === 5){
        if(idx === 0) space++;
        if(idx === 1) alt++;
        if(idx === 2) philo++;
        if(idx === 3) hard++;
      }
    });
  });

  const scores = [
    {key:"hard", score:hard},
    {key:"alt", score:alt},
    {key:"philo", score:philo},
    {key:"space", score:space}
  ].sort((a,b)=>b.score - a.score);

  if(scores[0].score === 0){
    resultDiv.textContent = "请至少在每题选择一个选项，再查看结果。";
    return;
  }

  const topKey = scores[0].key;
  let explain = "";
  let recTitles = [];

  if(topKey === "hard"){
    explain = "你对“硬科幻”和科学设定的严谨性有明显偏好，适合从太空工程、技术细节丰富的作品读起。";
    recTitles = ["穿越土星环","三体","太阳系大乐透"];
  }else if(topKey === "alt"){
    explain = "你对“架空历史”和社会制度演化更感兴趣，适合从历史分叉、帝国与战争结构相关的作品读起。";
    recTitles = ["城防十六计","苦涩之种","极冷之战","米与盐的时代"];
  }else if(topKey === "philo"){
    explain = "你更偏好“哲学科幻”和意识、现实结构相关的问题，适合阅读思想实验与形而上意味较强的作品。";
    recTitles = ["中局","八头斯芬克斯与五十六个答案","神圣入侵"];
  }else if(topKey === "space"){
    explain = "你对“太空歌剧”和文明尺度的史诗叙事有偏好，适合从宏大格局与外星文明相关的作品读起。";
    recTitles = ["名为帝国的回忆","三体","穿越土星环"];
  }

  resultDiv.innerHTML = "";
  const p = document.createElement("p");
  p.textContent = explain;
  resultDiv.appendChild(p);

  const booksWrap = document.createElement("div");
  booksWrap.className = "result-books";

  recTitles.forEach(title=>{
    const w = DATA.works.find(item=>item.title === title);
    if(!w) return;

    const card = document.createElement("div");
    card.className = "result-book";

    const img = document.createElement("img");
    img.className = "result-book-cover";
    img.src = "assets/covers/" + w.cover;
    img.alt = w.title;
    card.appendChild(img);

    const t = document.createElement("h4");
    t.className = "result-book-title";
    t.textContent = w.title;
    card.appendChild(t);

    const meta = document.createElement("div");
    meta.className = "result-book-meta";
    meta.textContent = w.author + "｜" + w.origin;
    card.appendChild(meta);

    const tagRow = document.createElement("div");
    tagRow.className = "result-book-tags";
    w.tags.forEach(tag=>{
      const span = document.createElement("span");
      span.className = "result-book-tag";
      span.textContent = tag;
      tagRow.appendChild(span);
    });
    card.appendChild(tagRow);

    booksWrap.appendChild(card);
  });

  resultDiv.appendChild(booksWrap);
}

/* 启动 */
window.addEventListener("DOMContentLoaded", ()=>{
  scrollToWorks();
  renderGuides();
  renderWorks();
  renderQuiz();
});
